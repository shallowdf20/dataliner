

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>preprocessing &mdash; dataliner  documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> dataliner
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../preprocessing.html">preprocessing module</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">dataliner</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Module code</a> &raquo;</li>
        
      <li>preprocessing</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for preprocessing</h1><div class="highlight"><pre>
<span></span><span class="c1"># -*- coding: utf-8 -*-</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">A dataprocessing package for data preprocess and feature engineering.</span>

<span class="sd">This library contains preprocessing methods for data processing</span>
<span class="sd">and feature engineering used during data analysis and machine learning </span>
<span class="sd">process.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">import</span> <span class="nn">itertools</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">warnings</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">from</span> <span class="nn">sklearn.base</span> <span class="kn">import</span> <span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span>
<span class="kn">from</span> <span class="nn">sklearn.cluster</span> <span class="kn">import</span> <span class="n">KMeans</span>
<span class="kn">from</span> <span class="nn">sklearn.decomposition</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">sklearn.ensemble</span> <span class="kn">import</span> <span class="n">IsolationForest</span><span class="p">,</span> <span class="n">RandomForestClassifier</span>
<span class="kn">from</span> <span class="nn">sklearn.linear_model</span> <span class="kn">import</span> <span class="n">LogisticRegression</span>
<span class="kn">from</span> <span class="nn">sklearn.metrics</span> <span class="kn">import</span> <span class="n">roc_auc_score</span>
<span class="kn">from</span> <span class="nn">sklearn.model_selection</span> <span class="kn">import</span> <span class="n">cross_val_score</span><span class="p">,</span> <span class="n">StratifiedKFold</span>
<span class="kn">from</span> <span class="nn">sklearn.pipeline</span> <span class="kn">import</span> <span class="n">make_pipeline</span>
<span class="kn">from</span> <span class="nn">sklearn.utils.validation</span> <span class="kn">import</span> <span class="n">check_is_fitted</span>


<span class="n">__all__</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s1">&#39;DropColumns&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DropNoVariance&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DropHighCardinality&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DropLowAUC&#39;</span><span class="p">,</span>
    <span class="s1">&#39;DropHighCorrelation&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ImputeNaN&#39;</span><span class="p">,</span>
    <span class="s1">&#39;OneHotEncoding&#39;</span><span class="p">,</span>
    <span class="s1">&#39;BinarizeNaN&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CountRowNaN&#39;</span><span class="p">,</span>
    <span class="s1">&#39;ClipData&#39;</span><span class="p">,</span>
    <span class="s1">&#39;GroupRareCategory&#39;</span><span class="p">,</span>
    <span class="s1">&#39;TargetMeanEncoding&#39;</span><span class="p">,</span>
    <span class="s1">&#39;StandardScaling&#39;</span><span class="p">,</span>
    <span class="s1">&#39;MinMaxScaling&#39;</span><span class="p">,</span>
    <span class="s1">&#39;CountEncoding&#39;</span><span class="p">,</span>
    <span class="s1">&#39;RankedCountEncoding&#39;</span><span class="p">,</span>
    <span class="s1">&#39;FrequencyEncoding&#39;</span><span class="p">,</span>
    <span class="s1">&#39;RankedTargetMeanEncoding&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AppendAnomalyScore&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AppendCluster&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AppendClusterDistance&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AppendPrincipalComponent&#39;</span><span class="p">,</span>
    <span class="s1">&#39;AppendArithmeticFeatures&#39;</span><span class="p">,</span> <span class="c1"># from 1.2</span>
    <span class="s1">&#39;RankedEvaluationMetricEncoding&#39;</span><span class="p">,</span> <span class="c1"># from 1.2</span>
    <span class="s1">&#39;AppendClassificationModel&#39;</span><span class="p">,</span> <span class="c1"># from 1.2</span>
    <span class="s1">&#39;AppendEncoder&#39;</span><span class="p">,</span> <span class="c1"># from 1.2</span>
    <span class="s1">&#39;AppendClusterTargetMean&#39;</span><span class="p">,</span> <span class="c1"># from 1.2</span>
    <span class="s1">&#39;PermutationImportanceTest&#39;</span><span class="p">,</span> <span class="c1"># from 1.2</span>
    <span class="s1">&#39;UnionAppend&#39;</span><span class="p">,</span> <span class="c1"># from 1.3</span>
    <span class="s1">&#39;load_titanic&#39;</span><span class="p">,</span> <span class="c1"># from 1.3</span>
<span class="p">]</span>


<span class="k">def</span> <span class="nf">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input X is not a pandas DataFrame.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_y</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">y</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Input y is not a pandas Series.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_X_y</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
    <span class="n">_check_y</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">y</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Number of rows are different between X and y.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_duplicate</span><span class="p">(</span><span class="n">list_</span><span class="p">):</span>
    <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">list_</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">_check_fit</span><span class="p">(</span><span class="n">list1</span><span class="p">,</span> <span class="n">list2</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">set</span><span class="p">(</span><span class="n">list1</span><span class="p">)</span> <span class="o">==</span> <span class="nb">set</span><span class="p">(</span><span class="n">list2</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="n">_check_duplicate</span><span class="p">(</span><span class="n">list1</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_check_duplicate</span><span class="p">(</span><span class="n">list2</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;There are features with duplicate name.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Columns are different from when fitted. For</span><span class="se">\</span>
<span class="s2">                preprocess with model transforming such as Isolation</span><span class="se">\</span>
<span class="s2">                Forest or KMeans, it require the columns to be same.&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_binary</span><span class="p">(</span><span class="n">y</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">unique</span><span class="p">())</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;This class can only be used for Binary Classification&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_check_method_implemented</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">method_str</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">method_str</span> <span class="ow">in</span> <span class="nb">dir</span><span class="p">(</span><span class="n">model</span><span class="p">):</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">method_str</span> <span class="o">+</span> <span class="s1">&#39; is not implemented in the specified model&#39;</span><span class="p">)</span>


<div class="viewcode-block" id="load_titanic"><a class="viewcode-back" href="../preprocessing.html#preprocessing.load_titanic">[docs]</a><span class="k">def</span> <span class="nf">load_titanic</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load train and test data for titanic datasets.</span>

<span class="sd">    :return: train_features, train_target, test_features</span>
<span class="sd">    :rtype: pandas.DataFrame, pandas.Series, pandas.DataFrame</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="vm">__file__</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/datasets/titanic_train.csv&#39;</span><span class="p">)</span>
    <span class="n">X_test</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span> <span class="o">+</span> <span class="s1">&#39;/datasets/titanic_test.csv&#39;</span><span class="p">)</span>
    <span class="n">X</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Survived&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;Survived&#39;</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">X</span><span class="p">,</span> <span class="n">X_test</span><span class="p">,</span> <span class="n">y</span></div>


<div class="viewcode-block" id="DropColumns"><a class="viewcode-back" href="../preprocessing.html#preprocessing.DropColumns">[docs]</a><span class="k">class</span> <span class="nc">DropColumns</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Simply delete columns specified from input dataframe.</span>

<span class="sd">    :param list drop_columns: List of feature names which will be droped \</span>
<span class="sd">    from input dataframe. For single columns, string can also be used.\</span>
<span class="sd">    (default=None)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drop_columns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns</span> <span class="o">=</span> <span class="n">drop_columns</span>

<div class="viewcode-block" id="DropColumns.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.DropColumns.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer by checking X is a pandas DataFrame.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_columns</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                    <span class="k">pass</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Specified columns are not in the input.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Specified column is not in the input.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">is_fitted_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DropColumns.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.DropColumns.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by dropping columns specified in drop_columns</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">X</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="DropNoVariance"><a class="viewcode-back" href="../preprocessing.html#preprocessing.DropNoVariance">[docs]</a><span class="k">class</span> <span class="nc">DropNoVariance</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete columns which only have single unique value.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="DropNoVariance.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.DropNoVariance.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer by deleting column with single unique value.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">X</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DropNoVariance.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.DropNoVariance.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by dropping columns specified in drop_columns</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">drop_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">drop_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span>

        <span class="k">if</span> <span class="n">drop_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">X</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="DropHighCardinality"><a class="viewcode-back" href="../preprocessing.html#preprocessing.DropHighCardinality">[docs]</a><span class="k">class</span> <span class="nc">DropHighCardinality</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete columns with high cardinality.</span>
<span class="sd">    Basically means dropping column with too many categories.</span>

<span class="sd">    :param int max_categories: Maximum number of categories to be permitted\</span>
<span class="sd">    in a column. If number of categories in a certain column exceeds this\</span>
<span class="sd">    value, that column will be deleted. (default=50)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_categories</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_categories</span> <span class="o">=</span> <span class="n">max_categories</span>

<div class="viewcode-block" id="DropHighCardinality.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.DropHighCardinality.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer by deleting column with high cardinality.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">cat_columns</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>

        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">cat_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">X</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">unique</span><span class="p">()</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_categories</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DropHighCardinality.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.DropHighCardinality.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by dropping columns specified in drop_columns</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">drop_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">drop_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span>

        <span class="k">if</span> <span class="n">drop_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">X</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="DropLowAUC"><a class="viewcode-back" href="../preprocessing.html#preprocessing.DropLowAUC">[docs]</a><span class="k">class</span> <span class="nc">DropLowAUC</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete columns that have low information to predict target variable.\</span>
<span class="sd">    This class calculate roc_auc by fitting all features in the input\</span>
<span class="sd">    array one by one against target feature using Logistic Regression\</span>
<span class="sd">    and drop features with roc_auc below threshold specified.\</span>
<span class="sd">    Missing values will be replaced by mean and categorical feature \</span>
<span class="sd">    will be converted to dummy variables by one hot encoding with missing\</span>
<span class="sd">    values filled with mode.</span>

<span class="sd">    :param float threshold: Threshold value for roc_auc. Feature with roc_auc \</span>
<span class="sd">    below this value will be deleted. (default=0.51)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.51</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>

<div class="viewcode-block" id="DropLowAUC.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.DropLowAUC.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer by fitting each feature with Logistic \</span>
<span class="sd">        Regression and storing features with roc_auc less than threshold </span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Input Series for target variable</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X_y</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">_check_binary</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">X_lr</span> <span class="o">=</span> <span class="n">X</span><span class="p">[[</span><span class="n">feature</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">X_lr</span><span class="o">.</span><span class="n">dtypes</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;object&#39;</span><span class="p">:</span>
                <span class="n">mode</span> <span class="o">=</span> <span class="n">X_lr</span><span class="o">.</span><span class="n">mode</span><span class="p">()</span>
                <span class="n">X_lr</span> <span class="o">=</span> <span class="n">X_lr</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mode</span><span class="p">)</span>
                <span class="n">X_lr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X_lr</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">mean</span> <span class="o">=</span> <span class="n">X_lr</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">X_lr</span> <span class="o">=</span> <span class="n">X_lr</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">mean</span><span class="p">)</span>

            <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">X_lr</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

            <span class="k">if</span> <span class="n">roc_auc</span> <span class="o">&lt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="o">=</span> <span class="p">[</span><span class="n">feature</span><span class="p">]</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span><span class="p">,</span> <span class="n">feature</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DropLowAUC.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.DropLowAUC.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by dropping columns specified in drop_columns</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">drop_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">drop_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span>

        <span class="k">if</span> <span class="n">drop_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">X</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="DropHighCorrelation"><a class="viewcode-back" href="../preprocessing.html#preprocessing.DropHighCorrelation">[docs]</a><span class="k">class</span> <span class="nc">DropHighCorrelation</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Delete features that are highly correlated to each other.\</span>
<span class="sd">    Best correlated feature against target variable will be\</span>
<span class="sd">    selected from the highly correlated pairs within X.</span>

<span class="sd">    :param float threshold: Threshold value for Pearson&#39;s correlation \</span>
<span class="sd">    coefficient. (default=0.95)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.95</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>

<div class="viewcode-block" id="DropHighCorrelation.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.DropHighCorrelation.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer by identifying highly correlated variable pairs\</span>
<span class="sd">        and dropping one that is less correlated to the target variable.\</span>
<span class="sd">        Missing values will be imputed by mean.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X_y</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="n">Xm</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">corr</span><span class="p">()</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">Xm</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">pair</span> <span class="o">=</span> <span class="n">Xm</span><span class="p">[</span><span class="n">feature</span><span class="p">][</span><span class="nb">abs</span><span class="p">(</span><span class="n">Xm</span><span class="p">[</span><span class="n">feature</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">pairs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>

        <span class="n">unique_pairs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span><span class="o">.</span><span class="n">to_numpy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">unique_pairs</span><span class="p">:</span>
            <span class="n">pearsons</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">pearson</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">corrcoef</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()),</span> <span class="n">y</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
                    <span class="n">pearsons</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">pearson</span><span class="p">))</span>
            <span class="n">best_col</span> <span class="o">=</span> <span class="n">pair</span><span class="p">[</span><span class="n">pearsons</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="nb">max</span><span class="p">(</span><span class="n">pearsons</span><span class="p">))]</span>

            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">pair</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">col</span> <span class="o">!=</span> <span class="n">best_col</span> <span class="ow">and</span> <span class="n">col</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="o">=</span> <span class="n">col</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span><span class="p">,</span> <span class="n">col</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="DropHighCorrelation.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.DropHighCorrelation.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by dropping columns specified in drop_columns</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">drop_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">drop_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">drop_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">X</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="ImputeNaN"><a class="viewcode-back" href="../preprocessing.html#preprocessing.ImputeNaN">[docs]</a><span class="k">class</span> <span class="nc">ImputeNaN</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Look for NaN values in the dataframe and impute by\</span>
<span class="sd">    strategy such as mean, median and mode.</span>

<span class="sd">    :param string cat_strategy: Strategy for imputing NaN exist in categorical\</span>
<span class="sd">    columns. If any other string apart from mode is specified, the\</span>
<span class="sd">    NaN will be imputed by fixed string name ImputedNaN. (default=&#39;mode&#39;)</span>
<span class="sd">    :param string num_strategy: Strategy for imputing NaN exist in numerical\</span>
<span class="sd">    columns. Either mean, median or mode can be specified and if any\</span>
<span class="sd">    other string is specified, mean imputation will be employed. (default=&#39;mean&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cat_strategy</span><span class="o">=</span><span class="s1">&#39;mode&#39;</span><span class="p">,</span> <span class="n">num_strategy</span><span class="o">=</span><span class="s1">&#39;mean&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_strategy</span> <span class="o">=</span> <span class="n">cat_strategy</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">num_strategy</span> <span class="o">=</span> <span class="n">num_strategy</span>
    
<div class="viewcode-block" id="ImputeNaN.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.ImputeNaN.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer by identifying numerical and categorical\</span>
<span class="sd">        columns. Then, based on the strategy fit will store the\</span>
<span class="sd">        values used for NaN existing in each columns.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">num_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_imputes_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_imputes_</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_columns_</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_strategy</span> <span class="o">==</span> <span class="s1">&#39;mean&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_imputes_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_strategy</span> <span class="o">==</span> <span class="s1">&#39;median&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_imputes_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">median</span><span class="p">()</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_strategy</span> <span class="o">==</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_imputes_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">num_imputes_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_strategy</span> <span class="o">==</span> <span class="s1">&#39;mode&#39;</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cat_imputes_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mode</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">cat_imputes_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;ImputedNaN&#39;</span>
        
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ImputeNaN.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.ImputeNaN.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by imputing with values obtained from\</span>
<span class="sd">        fitting stage.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">num_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_columns_</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">cat_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">num_columns</span><span class="p">:</span>
            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_imputes_</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">cat_columns</span><span class="p">:</span>
            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_imputes_</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="OneHotEncoding"><a class="viewcode-back" href="../preprocessing.html#preprocessing.OneHotEncoding">[docs]</a><span class="k">class</span> <span class="nc">OneHotEncoding</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    One Hot Encoding of categorical variables.</span>

<span class="sd">    :param bool drop_first: Whether to drop first column after one \</span>
<span class="sd">    hot encoding in order to avoid multi-collinearity. (default=True)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">drop_first</span> <span class="o">=</span> <span class="n">drop_first</span>

<div class="viewcode-block" id="OneHotEncoding.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.OneHotEncoding.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer by getting column names after\</span>
<span class="sd">        one hot encoding.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dummy_cols_</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_first</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="OneHotEncoding.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.OneHotEncoding.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by one hot encoding. This will drop new columns\</span>
<span class="sd">        in the input and impute with dummy column with all values = 0\</span>
<span class="sd">        for column that has been deleted from fitting stage.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">drop_first</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_first</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_dummy_cols_</span> <span class="o">=</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">dummy_cols_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_dummy_cols_</span><span class="p">):</span>
            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">new_dummy_cols_</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">dummy_cols_</span><span class="p">):</span>
            <span class="n">Xt</span> <span class="o">=</span> <span class="n">Xt</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">Xt</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">dummy_cols_</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="BinarizeNaN"><a class="viewcode-back" href="../preprocessing.html#preprocessing.BinarizeNaN">[docs]</a><span class="k">class</span> <span class="nc">BinarizeNaN</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find a column with missing values, and create a new\</span>
<span class="sd">    column indicating whether a value was missing (0) or\</span>
<span class="sd">    not (1).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="BinarizeNaN.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.BinarizeNaN.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer by getting column names that\</span>
<span class="sd">        contains NaN</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">nan_info</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nan_columns_</span> <span class="o">=</span> <span class="n">nan_info</span><span class="p">[</span><span class="n">nan_info</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="BinarizeNaN.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.BinarizeNaN.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Transform by checking for columns containing NaN value\</span>
<span class="sd">        both during the fitting and transforming stage, then\</span>
<span class="sd">        binalizing NaN to a new column.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">new_nan_info</span> <span class="o">=</span> <span class="n">Xt</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span>
        <span class="n">new_nan_columns</span> <span class="o">=</span> <span class="n">new_nan_info</span><span class="p">[</span><span class="n">new_nan_info</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">index</span>

        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nan_columns_</span><span class="p">,</span> <span class="n">new_nan_columns</span><span class="p">):</span>
            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;_NaNFlag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">x</span> <span class="k">else</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nan_columns_</span><span class="p">,</span> <span class="n">new_nan_columns</span><span class="p">):</span>
            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span> <span class="o">+</span> <span class="s1">&#39;_NaNFlag&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="CountRowNaN"><a class="viewcode-back" href="../preprocessing.html#preprocessing.CountRowNaN">[docs]</a><span class="k">class</span> <span class="nc">CountRowNaN</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculates total number of NaN in a row and create</span>
<span class="sd">    a new column to store the total.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="CountRowNaN.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.CountRowNaN.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer by getting column names during fit.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cols_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="CountRowNaN.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.CountRowNaN.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform by checking for columns that exists in both\</span>
<span class="sd">        the fitting and transforming stage. Then adds up number of\</span>
<span class="sd">        missing values in row direction.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">check_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cols_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="n">Xt</span><span class="p">[</span><span class="s1">&#39;NaN_Totals&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[</span><span class="n">check_columns</span><span class="p">]</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="ClipData"><a class="viewcode-back" href="../preprocessing.html#preprocessing.ClipData">[docs]</a><span class="k">class</span> <span class="nc">ClipData</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Clip datasets by replacing values larger than\</span>
<span class="sd">    the upper bound with upper bound and lower than \</span>
<span class="sd">    the lower bound by lower bound. Missing values will\</span>
<span class="sd">    be ignored.</span>

<span class="sd">    :param float threshold: Threshold value for to define upper and \</span>
<span class="sd">    lower bound. For example, 0.99 will imply upper bound at 99% percentile\</span>
<span class="sd">    annd lower bound at 1% percentile. (default=0.99)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.99</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>

<div class="viewcode-block" id="ClipData.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.ClipData.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer to get upper bound and lower bound for\</span>
<span class="sd">        numerical columns.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">upperbounds_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">lowerbounds_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_columns_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">upperbounds_</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">lowerbounds_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span>
                <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">dropna</span><span class="p">(),</span> <span class="p">[</span><span class="mi">100</span><span class="o">-</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">*</span><span class="mi">100</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="o">*</span><span class="mi">100</span><span class="p">])</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="ClipData.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.ClipData.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform by clipping numerical data</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">clip_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_columns_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">clip_columns</span><span class="p">:</span>
            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">(),</span> 
                              <span class="bp">self</span><span class="o">.</span><span class="n">upperbounds_</span><span class="p">[</span><span class="n">col</span><span class="p">],</span>
                              <span class="bp">self</span><span class="o">.</span><span class="n">lowerbounds_</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>

        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="GroupRareCategory"><a class="viewcode-back" href="../preprocessing.html#preprocessing.GroupRareCategory">[docs]</a><span class="k">class</span> <span class="nc">GroupRareCategory</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Replace rare categories that appear in categorical columns\</span>
<span class="sd">    with dummy string.</span>

<span class="sd">    :param float threshold: Threshold value for defining &quot;rare&quot;\</span>
<span class="sd">    category. For example, 0.01 will imply 1% of the total number\</span>
<span class="sd">    of data as &quot;rare&quot;. (default=0.01)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.01</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>

<div class="viewcode-block" id="GroupRareCategory.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.GroupRareCategory.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer to define and store rare categories\</span>
<span class="sd">        to be replaced.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">rare_categories_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">:</span>
            <span class="n">catcounts</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">rare_categories</span> <span class="o">=</span> <span class="n">catcounts</span><span class="p">[</span><span class="n">catcounts</span> <span class="o">&lt;=</span>
                    <span class="n">catcounts</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">]</span><span class="o">.</span><span class="n">index</span><span class="o">.</span><span class="n">tolist</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">rare_categories_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">rare_categories</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="GroupRareCategory.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.GroupRareCategory.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform by replacing rare category with dummy string.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">group_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">group_columns</span><span class="p">:</span>
            <span class="n">rare_categories</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">rare_categories_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>

            <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">rare_categories</span><span class="p">:</span>
                <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">cat</span><span class="p">,</span> <span class="s1">&#39;RareCategory&#39;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="TargetMeanEncoding"><a class="viewcode-back" href="../preprocessing.html#preprocessing.TargetMeanEncoding">[docs]</a><span class="k">class</span> <span class="nc">TargetMeanEncoding</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Target Mean Encoding of categorical variables. Missing\</span>
<span class="sd">    values will be treated as one of the categories.</span>

<span class="sd">    :param float k: hyperparameter for sigmoid function (default=0.0)</span>
<span class="sd">    :param float f: hyperparameter for sigmoid function (default=1.0)</span>
<span class="sd">    :param float smoothing: Whether to smooth target mean with global mean using\</span>
<span class="sd">    sigmoid function. Do not recommend smoothing=False. (default=0.01)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span> <span class="o">=</span> <span class="n">smoothing</span>
    
    <span class="k">def</span> <span class="nf">_sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">f</span><span class="p">))</span>

<div class="viewcode-block" id="TargetMeanEncoding.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.TargetMeanEncoding.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer to define and store target mean \</span>
<span class="sd">        smoothed target mean for categorical variables.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Input Series for target variable</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X_y</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="n">target</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">name</span>
        <span class="n">global_mean</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_mean_</span> <span class="o">=</span> <span class="n">global_mean</span>
        <span class="n">sigmoid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sigmoid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dic_target_mean_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">y</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;_Missing&#39;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">local_means</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">target</span><span class="p">:</span><span class="s1">&#39;target_mean&#39;</span><span class="p">})</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">target</span><span class="p">:</span><span class="s1">&#39;count&#39;</span><span class="p">})</span>

            <span class="n">df_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">local_means</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
            <span class="n">lambda_</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">df_summary</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">)</span>

            <span class="n">df_summary</span><span class="p">[</span><span class="s1">&#39;smoothed_target_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lambda_</span> <span class="o">*</span> <span class="n">df_summary</span><span class="p">[</span>
                    <span class="s1">&#39;target_mean&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lambda_</span><span class="p">)</span> <span class="o">*</span> <span class="n">global_mean</span>
            <span class="n">df_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_summary</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;smoothed_target_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_mean</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dic_target_mean_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_summary</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="TargetMeanEncoding.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.TargetMeanEncoding.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform by replacing categories with smoothed target mean</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">encode_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">encode_columns</span><span class="p">:</span>
            <span class="n">df_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_target_mean_</span><span class="p">[</span><span class="n">col</span><span class="p">][[</span><span class="n">col</span><span class="p">,</span>
                    <span class="s1">&#39;smoothed_target_mean&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;_Missing&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[[</span><span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;_Missing&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_map</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">global_mean_</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="StandardScaling"><a class="viewcode-back" href="../preprocessing.html#preprocessing.StandardScaling">[docs]</a><span class="k">class</span> <span class="nc">StandardScaling</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Standardize datasets to have mean = 0 and std = 1.\</span>
<span class="sd">    Note this will only standardize numerical data\</span>
<span class="sd">    and ignore missing values during computation.\</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="StandardScaling.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.StandardScaling.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer to get mean and std for each\</span>
<span class="sd">        numerical features.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dic_mean_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dic_std_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_columns_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dic_mean_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dic_std_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="StandardScaling.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.StandardScaling.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform by subtracting mean and dividing by std.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">standardize_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_columns_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">standardize_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_std_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_mean_</span><span class="p">[</span><span class="n">col</span><span class="p">])</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_std_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        
        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="MinMaxScaling"><a class="viewcode-back" href="../preprocessing.html#preprocessing.MinMaxScaling">[docs]</a><span class="k">class</span> <span class="nc">MinMaxScaling</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Rescale the fit data into range between 0 and 1.\</span>
<span class="sd">    Note this will only standardize numerical data\</span>
<span class="sd">    and ignore missing values during computation.\</span>
<span class="sd">    If there are values larger/smaller than fit data in the\</span>
<span class="sd">    transform data, the value will be larger than 1\</span>
<span class="sd">    or less than 0.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="MinMaxScaling.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.MinMaxScaling.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer to get min and max values for each\</span>
<span class="sd">        numerical features.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">num_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
        
        <span class="bp">self</span><span class="o">.</span><span class="n">dic_min_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dic_max_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">num_columns_</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dic_min_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dic_max_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="MinMaxScaling.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.MinMaxScaling.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform by subtracting min and dividing by max-min.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">minmax_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">num_columns_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">minmax_columns</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_max_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_min_</span><span class="p">[</span><span class="n">col</span><span class="p">]:</span>
                <span class="k">pass</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_min_</span><span class="p">[</span><span class="n">col</span><span class="p">])</span> <span class="o">/</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">dic_max_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_min_</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
        
        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="CountEncoding"><a class="viewcode-back" href="../preprocessing.html#preprocessing.CountEncoding">[docs]</a><span class="k">class</span> <span class="nc">CountEncoding</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encode categorical variables by the count of category\</span>
<span class="sd">    within the categorical column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="CountEncoding.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.CountEncoding.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer to define categorical variables and\</span>
<span class="sd">        obtain occurrence of each categories.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dic_counts_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))],</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;_Missing&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s1">&#39;count&#39;</span><span class="p">})</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dic_counts_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">counts</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="CountEncoding.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.CountEncoding.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform by replacing categories with counts</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">encode_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">encode_columns</span><span class="p">:</span>
            <span class="n">df_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_counts_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;_Missing&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[[</span><span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;_Missing&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_map</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="RankedCountEncoding"><a class="viewcode-back" href="../preprocessing.html#preprocessing.RankedCountEncoding">[docs]</a><span class="k">class</span> <span class="nc">RankedCountEncoding</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Firstly encode categorical variables by the count of category\</span>
<span class="sd">    within the categorical column. Then, counts are ranked in\</span>
<span class="sd">    descending order and the ranks are used to encode category\</span>
<span class="sd">    columns. Even in case there are categories with same counts,\</span>
<span class="sd">    ranking will be based on the index and therefore the\</span>
<span class="sd">    categories will be distinguished. RankedFrequencyEncoding\</span>
<span class="sd">    is not provided as the result will be identical to this class.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="RankedCountEncoding.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.RankedCountEncoding.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer to define categorical variables and\</span>
<span class="sd">        obtain ranking of category counts.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dic_ranks_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">:</span>
            <span class="n">df_rank</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;_Missing&#39;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">value_counts</span><span class="p">(</span><span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">df_rank</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Rank&#39;</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="s1">&#39;Counts&#39;</span><span class="p">]</span>
            <span class="n">df_rank</span><span class="p">[</span><span class="s1">&#39;Rank&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">df_rank</span> <span class="o">=</span> <span class="n">df_rank</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dic_ranks_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_rank</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="RankedCountEncoding.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.RankedCountEncoding.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform by replacing categories with ranks</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">encode_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">encode_columns</span><span class="p">:</span>
            <span class="n">df_rank</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_ranks_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[[</span><span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;_Missing&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_rank</span><span class="p">,</span>
                    <span class="n">on</span><span class="o">=</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">([</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;Counts&#39;</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df_rank</span><span class="p">[</span><span class="s1">&#39;Rank&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="FrequencyEncoding"><a class="viewcode-back" href="../preprocessing.html#preprocessing.FrequencyEncoding">[docs]</a><span class="k">class</span> <span class="nc">FrequencyEncoding</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encode categorical variables by the frequency of category\</span>
<span class="sd">    within the categorical column.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">pass</span>

<div class="viewcode-block" id="FrequencyEncoding.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.FrequencyEncoding.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer to define categorical variables and\</span>
<span class="sd">        obtain frequency of each categories.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dic_freq_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))],</span>
                    <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;_Missing&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">df_count</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
            <span class="n">df_count</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="n">col</span><span class="p">,</span> <span class="s1">&#39;Frequency&#39;</span><span class="p">]</span>
            <span class="n">df_count</span><span class="p">[</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_count</span><span class="p">[[</span><span class="s1">&#39;Frequency&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span>
                    <span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span> <span class="o">/</span> <span class="n">x</span><span class="o">.</span><span class="n">sum</span><span class="p">())</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">dic_freq_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_count</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="FrequencyEncoding.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.FrequencyEncoding.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform by replacing categories with frequency</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">encode_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">encode_columns</span><span class="p">:</span>
            <span class="n">df_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_freq_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;_Missing&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[[</span><span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;_Missing&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_map</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="RankedTargetMeanEncoding"><a class="viewcode-back" href="../preprocessing.html#preprocessing.RankedTargetMeanEncoding">[docs]</a><span class="k">class</span> <span class="nc">RankedTargetMeanEncoding</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Ranking with Target Mean Encoding of categorical variables. Missing\</span>
<span class="sd">    values will be treated as one of the categories. This will treat\</span>
<span class="sd">    Categories with same target mean separately as the rank is obtained\</span>
<span class="sd">    from index once sorted by target mean.</span>

<span class="sd">    :param float k: hyperparameter for sigmoid function (default=0.0)</span>
<span class="sd">    :param float f: hyperparameter for sigmoid function (default=1.0)</span>
<span class="sd">    :param float smoothing: Whether to smooth target mean with global mean using\</span>
<span class="sd">    sigmoid function. Do not recommend smoothing=False. (default=0.01)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">smoothing</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">k</span> <span class="o">=</span> <span class="n">k</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">f</span> <span class="o">=</span> <span class="n">f</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">smoothing</span> <span class="o">=</span> <span class="n">smoothing</span>
    
    <span class="k">def</span> <span class="nf">_sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">k</span><span class="p">,</span> <span class="n">f</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">f</span><span class="p">))</span>

<div class="viewcode-block" id="RankedTargetMeanEncoding.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.RankedTargetMeanEncoding.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer to define and store target mean \</span>
<span class="sd">        smoothed target mean for categorical variables.\</span>
<span class="sd">        Then, ranking is created based on target mean.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Input Series for target variable</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X_y</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="n">target</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">name</span>
        <span class="n">global_mean</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_mean_</span> <span class="o">=</span> <span class="n">global_mean</span>
        <span class="n">sigmoid</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vectorize</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_sigmoid</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dic_target_mean_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">:</span>
            <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">X</span><span class="p">[</span><span class="n">col</span><span class="p">],</span> <span class="n">y</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;_Missing&#39;</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">as_index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">local_means</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">target</span><span class="p">:</span><span class="s1">&#39;target_mean&#39;</span><span class="p">})</span>
            <span class="n">counts</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">target</span><span class="p">:</span><span class="s1">&#39;count&#39;</span><span class="p">})</span>

            <span class="n">df_summary</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">local_means</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">col</span><span class="p">)</span>
            <span class="n">lambda_</span> <span class="o">=</span> <span class="n">sigmoid</span><span class="p">(</span><span class="n">df_summary</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">f</span><span class="p">)</span>

            <span class="n">df_summary</span><span class="p">[</span><span class="s1">&#39;smoothed_target_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lambda_</span> <span class="o">*</span> <span class="n">df_summary</span><span class="p">[</span>
                    <span class="s1">&#39;target_mean&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lambda_</span><span class="p">)</span> <span class="o">*</span> <span class="n">global_mean</span>
            <span class="n">df_summary</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_summary</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
                    <span class="s1">&#39;smoothed_target_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_mean</span>
            
            <span class="n">df_summary</span> <span class="o">=</span> <span class="n">df_summary</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;smoothed_target_mean&#39;</span>
                    <span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">df_summary</span> <span class="o">=</span> <span class="n">df_summary</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;Rank&#39;</span><span class="p">})</span>
            <span class="n">df_summary</span><span class="p">[</span><span class="s1">&#39;Rank&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dic_target_mean_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_summary</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="RankedTargetMeanEncoding.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.RankedTargetMeanEncoding.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform by replacing categories with rank</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">encode_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">encode_columns</span><span class="p">:</span>
            <span class="n">df_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_target_mean_</span><span class="p">[</span><span class="n">col</span><span class="p">][[</span><span class="n">col</span><span class="p">,</span>
                    <span class="s1">&#39;Rank&#39;</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;_Missing&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="n">col</span><span class="p">)</span>
            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[[</span><span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;_Missing&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_map</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">df_map</span><span class="p">[</span><span class="s1">&#39;Rank&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="AppendAnomalyScore"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendAnomalyScore">[docs]</a><span class="k">class</span> <span class="nc">AppendAnomalyScore</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Append anomaly score calculated from isolation forest.\</span>
<span class="sd">    Since IsolationForest needs to be fitted, category columns must\</span>
<span class="sd">    first be encoded to numerical values.</span>

<span class="sd">    :param int n_estimators: Number of base estimators in the \</span>
<span class="sd">        Isolation Forest ensemble. (default=100)</span>
<span class="sd">    :param int random_state: random_state for Isolation Forest \</span>
<span class="sd">        (default=1234)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_estimators</span><span class="o">=</span><span class="mi">100</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1234</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_estimators</span> <span class="o">=</span> <span class="n">n_estimators</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>

<div class="viewcode-block" id="AppendAnomalyScore.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendAnomalyScore.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit Isolation Forest</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_</span> <span class="o">=</span> <span class="n">IsolationForest</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_estimators</span><span class="p">,</span>
                                      <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="AppendAnomalyScore.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendAnomalyScore.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by appending anomaly score</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">_check_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_columns_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">Xt</span><span class="p">[</span><span class="s1">&#39;Anomaly_Score&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="o">.</span><span class="n">decision_function</span><span class="p">(</span><span class="n">Xt</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="AppendCluster"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendCluster">[docs]</a><span class="k">class</span> <span class="nc">AppendCluster</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Append cluster number obtained from kmeans++ clustering.\</span>
<span class="sd">    For clustering categorical variables need to be converted\</span>
<span class="sd">    to numerical data.</span>

<span class="sd">    :param int n_clusters: Number of clusters (default=8)</span>
<span class="sd">    :param int random_state: random_state for KMeans \</span>
<span class="sd">        (default=1234)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1234</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_clusters</span> <span class="o">=</span> <span class="n">n_clusters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>

<div class="viewcode-block" id="AppendCluster.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendCluster.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit KMeans Clustering</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">,</span>
                             <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="AppendCluster.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendCluster.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by appending cluster number</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">_check_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_columns_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">Xt</span><span class="p">[</span><span class="s1">&#39;Cluster_Number&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xt</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="AppendClusterDistance"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendClusterDistance">[docs]</a><span class="k">class</span> <span class="nc">AppendClusterDistance</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Append cluster distance obtained from kmeans++ clustering.\</span>
<span class="sd">    For clustering categorical variables need to be converted\</span>
<span class="sd">    to numerical data.</span>

<span class="sd">    :param int n_clusters: Number of clusters (default=8)</span>
<span class="sd">    :param int random_state: random_state for KMeans \</span>
<span class="sd">        (default=1234)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1234</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_clusters</span> <span class="o">=</span> <span class="n">n_clusters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>

<div class="viewcode-block" id="AppendClusterDistance.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendClusterDistance.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit KMeans Clustering</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">,</span>
                             <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="AppendClusterDistance.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendClusterDistance.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by appending cluster distance</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">_check_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_columns_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">df_clusters</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Xt</span><span class="p">)</span>
                 <span class="p">)</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;Cluster_Distance_&#39;</span><span class="p">)</span>
        <span class="n">df_clusters</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">Xt</span><span class="o">.</span><span class="n">index</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Xt</span><span class="p">,</span> <span class="n">df_clusters</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="AppendPrincipalComponent"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendPrincipalComponent">[docs]</a><span class="k">class</span> <span class="nc">AppendPrincipalComponent</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Append principal components obtained from PCA.\</span>
<span class="sd">    For pca categorical variables need to be converted\</span>
<span class="sd">    to numerical data. Also, data should be standardized beforehand.</span>

<span class="sd">    :param int n_components: Number of principal components (default=5)</span>
<span class="sd">    :param int random_state: random_state for PCA \</span>
<span class="sd">        (default=1234)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_components</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1234</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_components</span> <span class="o">=</span> <span class="n">n_components</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>

<div class="viewcode-block" id="AppendPrincipalComponent.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendPrincipalComponent.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit PCA</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span><span class="n">n_components</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_components</span><span class="p">,</span>
                          <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="AppendPrincipalComponent.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendPrincipalComponent.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by appending principal components</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">_check_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_columns_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">df_pca</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">Xt</span><span class="p">)</span>
                 <span class="p">)</span><span class="o">.</span><span class="n">add_prefix</span><span class="p">(</span><span class="s1">&#39;Principal_Component_&#39;</span><span class="p">)</span>
        <span class="n">df_pca</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">Xt</span><span class="o">.</span><span class="n">index</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Xt</span><span class="p">,</span> <span class="n">df_pca</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="AppendArithmeticFeatures"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendArithmeticFeatures">[docs]</a><span class="k">class</span> <span class="nc">AppendArithmeticFeatures</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A transformer which recognizes all numerical features and create\</span>
<span class="sd">    new features by arithmetic operation. Newly created features\</span>
<span class="sd">    are evaluated individually by fitting Logistic Regression against\</span>
<span class="sd">    the target variable and only new features with higher eval metric than feature\</span>
<span class="sd">    pairs will be newly added to the data. Missing values need to be\</span>
<span class="sd">    imputed beforehand.</span>

<span class="sd">    :param int max_features: Number of numerical features to test\</span>
<span class="sd">    combinations. If number of numerical features in the data exceeds\</span>
<span class="sd">    this value, transformer will raise an exception. (default=50)</span>
<span class="sd">    :param string metric: Metrics to evaluate feature. Sklearn default\</span>
<span class="sd">    metrics can be used. (default=&#39;roc_auc&#39;)</span>
<span class="sd">    :param string operation: Type of arithmetic operations. &#39;add&#39;, \</span>
<span class="sd">    &#39;subtract&#39;, &#39;multiply&#39;, &#39;divide&#39; can be used. (default=&#39;multiply&#39;)</span>
<span class="sd">    :param float replace_zero: Value to replace 0 when operation=&#39;divide&#39;\</span>
<span class="sd">    . Do not use 0 as it may cause ZeroDivisionError.(default=0.001)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span>
                 <span class="n">max_features</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span>
                 <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">,</span>
                 <span class="n">operation</span><span class="o">=</span><span class="s1">&#39;multiply&#39;</span><span class="p">,</span>
                 <span class="n">replace_zero</span><span class="o">=</span><span class="mf">0.001</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">max_features</span> <span class="o">=</span> <span class="n">max_features</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operation</span> <span class="o">=</span> <span class="n">operation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">replace_zero</span> <span class="o">=</span> <span class="n">replace_zero</span>
    
    <span class="k">def</span> <span class="nf">_arithmetic_operation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">series1</span><span class="p">,</span> <span class="n">series2</span><span class="p">,</span> <span class="n">operation</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;add&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">series1</span> <span class="o">+</span> <span class="n">series2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;subtract&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">series1</span> <span class="o">-</span> <span class="n">series2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;multiply&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">series1</span> <span class="o">*</span> <span class="n">series2</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">operation</span> <span class="o">==</span> <span class="s1">&#39;divide&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">divide</span><span class="p">(</span><span class="n">series1</span><span class="p">,</span> <span class="n">series2</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">replace_zero</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Unknown arithmetic operation was specified : &#39;</span> <span class="o">+</span> <span class="n">operation</span><span class="p">)</span>
    
    <span class="k">def</span> <span class="nf">_check_missing</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">df</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">df</span><span class="o">.</span><span class="n">isna</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span><span class="o">.</span><span class="n">sum</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Please impute missing values before using this transformer.&#39;</span><span class="p">)</span>

<div class="viewcode-block" id="AppendArithmeticFeatures.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendArithmeticFeatures.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer by fitting each feature with Logistic\</span>
<span class="sd">        Regression and storing features with eval metrics higher\</span>
<span class="sd">        than the max of existing features.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Input Series for target variable</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X_y</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">_check_binary</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">x_features_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_missing</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_features_</span><span class="p">])</span>
        
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_features_</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_features</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s1">&#39;Number of numerical features is larger than max_features.&#39;</span><span class="p">)</span>

        <span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">)</span>
        
        <span class="c1"># Firstly find maximum evaluation metric in the existing feature</span>
        <span class="n">roc_auc_existing</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">x_features_</span><span class="p">:</span>
            <span class="n">X_lr</span> <span class="o">=</span> <span class="n">X</span><span class="p">[[</span><span class="n">feature</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="n">X</span><span class="p">[[</span><span class="n">feature</span><span class="p">]]</span><span class="o">.</span><span class="n">mean</span><span class="p">())</span>
        
            <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">X_lr</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">roc_auc_existing</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">roc_auc</span>

        <span class="c1"># Create feature by multiplication and employ if evaluation metric</span>
        <span class="c1"># is larger than the maximum of existing features</span>
        <span class="n">combinations</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">itertools</span><span class="o">.</span><span class="n">combinations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">x_features_</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">new_pair_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="n">combinations</span><span class="p">:</span>
            <span class="n">X_lr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arithmetic_operation</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">X</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation</span><span class="p">)</span>

            <span class="n">roc_auc</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">X_lr</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
            <span class="n">max_auc_pair</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="n">roc_auc_existing</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span>
                               <span class="n">roc_auc_existing</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]])</span>

            <span class="k">if</span> <span class="n">roc_auc</span> <span class="o">&gt;</span> <span class="n">max_auc_pair</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">new_pair_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pair</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="AppendArithmeticFeatures.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendArithmeticFeatures.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by creating new feature using pairs identified during fit.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_check_missing</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">x_features_</span><span class="p">])</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_pair_</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">X</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pair</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">new_pair_</span><span class="p">:</span>
                <span class="n">Xt</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_arithmetic_operation</span><span class="p">(</span>
                        <span class="n">Xt</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">Xt</span><span class="p">[</span><span class="n">pair</span><span class="p">[</span><span class="mi">1</span><span class="p">]],</span> <span class="bp">self</span><span class="o">.</span><span class="n">operation</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="RankedEvaluationMetricEncoding"><a class="viewcode-back" href="../preprocessing.html#preprocessing.RankedEvaluationMetricEncoding">[docs]</a><span class="k">class</span> <span class="nc">RankedEvaluationMetricEncoding</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Encode categorical columns by firstly creating dummy variable, then\</span>
<span class="sd">    LogisticRegression against target variable is fitted\</span>
<span class="sd">    for each of the dummy variables. Evaluation metric such as accuracy\</span>
<span class="sd">    or roc_auc is calculated and ranked. Finally, categories are encoded\</span>
<span class="sd">    with its rank. It is strongly recommended to conduct DropHighCardinality\</span>
<span class="sd">    or GroupRareCategory before using this encoding as this encoder will\</span>
<span class="sd">    fit Logistic Regression for ALL categories with 5-fold.</span>

<span class="sd">    :param string metric: Metrics to evaluate feature. Sklearn default\</span>
<span class="sd">    metrics can be used. (default=&#39;roc_auc&#39;)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">metric</span><span class="o">=</span><span class="s1">&#39;roc_auc&#39;</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">metric</span> <span class="o">=</span> <span class="n">metric</span>

<div class="viewcode-block" id="RankedEvaluationMetricEncoding.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.RankedEvaluationMetricEncoding.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer by creating dummy variable and fitting \</span>
<span class="sd">        LogisticRegression.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Input Series for target variable</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X_y</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">_check_binary</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">select_dtypes</span><span class="p">(</span><span class="n">exclude</span><span class="o">=</span><span class="s1">&#39;number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">columns</span>
        
        <span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">lr</span> <span class="o">=</span> <span class="n">LogisticRegression</span><span class="p">(</span><span class="n">penalty</span><span class="o">=</span><span class="s1">&#39;l2&#39;</span><span class="p">,</span> <span class="n">solver</span><span class="o">=</span><span class="s1">&#39;lbfgs&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">dic_corr_</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">:</span>
            <span class="n">X_lr</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">get_dummies</span><span class="p">(</span><span class="n">X</span><span class="p">[[</span><span class="n">feature</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;_Missing&#39;</span><span class="p">))</span>
            <span class="n">df_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([])</span>
            <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">X_lr</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">eval_metric</span> <span class="o">=</span> <span class="n">cross_val_score</span><span class="p">(</span><span class="n">lr</span><span class="p">,</span> <span class="n">X_lr</span><span class="p">[[</span><span class="n">col</span><span class="p">]],</span> <span class="n">y</span><span class="p">,</span> <span class="n">cv</span><span class="o">=</span><span class="n">cv</span><span class="p">,</span> <span class="n">scoring</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">metric</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
                <span class="n">df_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">df_map</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">([</span><span class="n">col</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">feature</span> <span class="o">+</span> <span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">),</span>
                        <span class="n">eval_metric</span><span class="p">])</span><span class="o">.</span><span class="n">T</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">df_map</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Category&#39;</span><span class="p">,</span> <span class="s1">&#39;Evaluation_Metric&#39;</span><span class="p">]</span>

            <span class="n">df_map</span> <span class="o">=</span> <span class="n">df_map</span><span class="o">.</span><span class="n">sort_values</span><span class="p">(</span><span class="s1">&#39;Evaluation_Metric&#39;</span>
                    <span class="p">,</span> <span class="n">ascending</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
            <span class="n">df_map</span> <span class="o">=</span> <span class="n">df_map</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;index&#39;</span><span class="p">:</span><span class="s1">&#39;Rank&#39;</span><span class="p">})</span>
            <span class="n">df_map</span><span class="p">[</span><span class="s1">&#39;Rank&#39;</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">df_map</span> <span class="o">=</span> <span class="n">df_map</span><span class="o">.</span><span class="n">set_index</span><span class="p">(</span><span class="s1">&#39;Category&#39;</span><span class="p">)</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">dic_corr_</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">df_map</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="RankedEvaluationMetricEncoding.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.RankedEvaluationMetricEncoding.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by replacing categories with its evaluation metric</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        
        <span class="n">encode_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">encode_columns</span><span class="p">:</span>
            <span class="n">df_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dic_corr_</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
            <span class="n">df_map</span> <span class="o">=</span> <span class="n">df_map</span><span class="p">[[</span><span class="s1">&#39;Rank&#39;</span><span class="p">]]</span>
            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[[</span><span class="n">col</span><span class="p">]]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="s1">&#39;_Missing&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_map</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="n">col</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">col</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">Xt</span><span class="p">[</span><span class="n">col</span><span class="p">]</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="AppendClassificationModel"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendClassificationModel">[docs]</a><span class="k">class</span> <span class="nc">AppendClassificationModel</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Append prediction from model as a new feature. Model must have\</span>
<span class="sd">    fit and predict methods and it should only predict a single\</span>
<span class="sd">    label. In case the model has a predict_proba method, option\</span>
<span class="sd">    probability can be used to append class probability instead\</span>
<span class="sd">    of class labels. predict_proba method must return class\</span>
<span class="sd">    probability for 0 as first column and 1 as second column.</span>

<span class="sd">    :param object model: Any model that is in line with sklearn \</span>
<span class="sd">    classification model, meaning it implements fit and predict.\</span>
<span class="sd">    (default=None)</span>
<span class="sd">    :param bool probability: Whether to class probability instead \</span>
<span class="sd">    of class labels. If True, model must have predict_proba method\</span>
<span class="sd">    implemented.(default=False)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">model</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">probability</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model</span> <span class="o">=</span> <span class="n">model</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">probability</span> <span class="o">=</span> <span class="n">probability</span>

<div class="viewcode-block" id="AppendClassificationModel.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendClassificationModel.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer by fitting model specified.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Input Series for target variable</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X_y</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">_check_binary</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model</span>
        <span class="n">_check_method_implemented</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="p">,</span> <span class="s1">&#39;fit&#39;</span><span class="p">)</span>
        <span class="n">_check_method_implemented</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="p">,</span> <span class="s1">&#39;predict&#39;</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">probability</span><span class="p">:</span>
            <span class="n">_check_method_implemented</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="p">,</span> <span class="s1">&#39;predict_proba&#39;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="AppendClassificationModel.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendClassificationModel.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by predicting with fitted model.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">_check_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_columns_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">probability</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">Xt</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">Xt</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xt</span><span class="p">)</span>
        
        <span class="n">pred_name</span> <span class="o">=</span> <span class="s1">&#39;Predicted_&#39;</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="n">Xt</span><span class="p">[</span><span class="n">pred_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">y_pred</span>

        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="AppendEncoder"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendEncoder">[docs]</a><span class="k">class</span> <span class="nc">AppendEncoder</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Append encoders in the DataLiner module. Encoders in DataLiner\</span>
<span class="sd">    will automatically replace categorical values, but by wrapping\</span>
<span class="sd">    DataLiner Encoders with this class, encoded results will be\</span>
<span class="sd">    appended as a new feature and original categorical columns\</span>
<span class="sd">    will remain. Regardless of whether the Encoder will require\</span>
<span class="sd">    target column or not, this class will require target column.</span>

<span class="sd">    :param object encoder: DataLiner Encoders.(default=None)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">encoder</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span> <span class="o">=</span> <span class="n">encoder</span>

<div class="viewcode-block" id="AppendEncoder.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendEncoder.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer by fitting encoder specified</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Input Series for target variable</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">y</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">_check_X_y</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">encoder_</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="AppendEncoder.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendEncoder.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by appending encoded category</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">_check_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_columns_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;_&#39;</span> <span class="o">+</span> <span class="nb">type</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder_</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="k">if</span> <span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;_OneHotEncoding&#39;</span><span class="p">:</span>
            <span class="n">Xa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder_</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">]</span>
                    <span class="p">)</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Xa</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">encoder_</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span>
                    <span class="p">)[</span><span class="bp">self</span><span class="o">.</span><span class="n">encoder_</span><span class="o">.</span><span class="n">cat_columns_</span><span class="p">]</span><span class="o">.</span><span class="n">add_suffix</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Xt</span><span class="p">,</span> <span class="n">Xa</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="AppendClusterTargetMean"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendClusterTargetMean">[docs]</a><span class="k">class</span> <span class="nc">AppendClusterTargetMean</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Append cluster number obtained from kmeans++ clustering.\</span>
<span class="sd">    Then each cluster number is replaced with target mean.\</span>
<span class="sd">    For clustering categorical variables need to be converted\</span>
<span class="sd">    to numerical data.</span>

<span class="sd">    :param int n_clusters: Number of clusters (default=8)</span>
<span class="sd">    :param int random_state: random_state for KMeans \</span>
<span class="sd">        (default=1234)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">n_clusters</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1234</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">n_clusters</span> <span class="o">=</span> <span class="n">n_clusters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">random_state</span> <span class="o">=</span> <span class="n">random_state</span>

    <span class="k">def</span> <span class="nf">_sigmoid</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">count</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">f</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">return</span> <span class="mi">1</span> <span class="o">/</span> <span class="p">(</span><span class="mi">1</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">exp</span><span class="p">(</span><span class="o">-</span> <span class="p">(</span><span class="n">count</span> <span class="o">-</span> <span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="n">f</span><span class="p">))</span>

<div class="viewcode-block" id="AppendClusterTargetMean.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendClusterTargetMean.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit KMeans Clustering and obtain target mean</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">_check_X_y</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="n">global_mean</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">global_mean_</span> <span class="o">=</span> <span class="n">global_mean</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">model_</span> <span class="o">=</span> <span class="n">KMeans</span><span class="p">(</span><span class="n">n_clusters</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">n_clusters</span><span class="p">,</span>
                             <span class="n">random_state</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">random_state</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fit_columns_</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span>
        
        <span class="n">cluster</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">df_cluster</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">cluster</span><span class="p">),</span>
                                  <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">y</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">df_cluster</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;Cluster_Number&#39;</span><span class="p">,</span> <span class="s1">&#39;Target&#39;</span><span class="p">]</span>

        <span class="n">mean</span> <span class="o">=</span> <span class="n">df_cluster</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Cluster_Number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Target&#39;</span><span class="p">:</span><span class="s1">&#39;target_mean&#39;</span><span class="p">})</span>
        <span class="n">count</span> <span class="o">=</span> <span class="n">df_cluster</span><span class="o">.</span><span class="n">groupby</span><span class="p">(</span><span class="s1">&#39;Cluster_Number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span>
            <span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;Target&#39;</span><span class="p">:</span><span class="s1">&#39;count&#39;</span><span class="p">})</span>
        <span class="n">df_map</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">mean</span><span class="p">,</span> <span class="n">count</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">lambda_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_sigmoid</span><span class="p">(</span><span class="n">df_map</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">])</span>
        <span class="n">df_map</span><span class="p">[</span><span class="s1">&#39;smoothed_target_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">lambda_</span> <span class="o">*</span> <span class="n">df_map</span><span class="p">[</span>
                    <span class="s1">&#39;target_mean&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">lambda_</span><span class="p">)</span> <span class="o">*</span> <span class="n">global_mean</span>
        <span class="n">df_map</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="n">df_map</span><span class="p">[</span><span class="s1">&#39;count&#39;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span>
                <span class="s1">&#39;smoothed_target_mean&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">global_mean</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cluster_target_mean_</span> <span class="o">=</span> <span class="n">df_map</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="AppendClusterTargetMean.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.AppendClusterTargetMean.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by appending cluster mean</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">_check_fit</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">fit_columns_</span><span class="p">,</span> <span class="n">Xt</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="n">Xc</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">model_</span><span class="o">.</span><span class="n">predict</span><span class="p">(</span><span class="n">Xt</span><span class="p">))</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="mi">0</span><span class="p">:</span><span class="s1">&#39;Cluster_Number&#39;</span><span class="p">})</span>
        
        <span class="n">df_map</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cluster_target_mean_</span>
        <span class="n">df_map</span> <span class="o">=</span> <span class="n">df_map</span><span class="p">[[</span><span class="s1">&#39;smoothed_target_mean&#39;</span><span class="p">]]</span>
        <span class="n">Xc</span> <span class="o">=</span> <span class="n">Xc</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">df_map</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s1">&#39;Cluster_Number&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s1">&#39;Cluster_Number&#39;</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">Xc</span> <span class="o">=</span> <span class="n">Xc</span><span class="o">.</span><span class="n">fillna</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Xt</span><span class="p">,</span> <span class="n">Xc</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;smoothed_target_mean&#39;</span><span class="p">:</span><span class="s1">&#39;cluster_mean&#39;</span><span class="p">})],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="PermutationImportanceTest"><a class="viewcode-back" href="../preprocessing.html#preprocessing.PermutationImportanceTest">[docs]</a><span class="k">class</span> <span class="nc">PermutationImportanceTest</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Conduct permutation importance tests on features and drop features\</span>
<span class="sd">    that are not effective. Basically it will firstly fit entire data,\</span>
<span class="sd">    then randomly shuffle each feature&#39;s data and evaluate the metrics\</span>
<span class="sd">    for both cases. If shuffled case has no difference in the evaluation\</span>
<span class="sd">    then that means the feature is not effective in prediction.</span>

<span class="sd">    :param float threshold: Average difference in roc_auc between original\</span>
<span class="sd">    and shuffled dataset. Higher the value, more features will be dropped.\</span>
<span class="sd">    (default=0.0001)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">threshold</span><span class="o">=</span><span class="mf">0.0001</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span> <span class="o">=</span> <span class="n">threshold</span>

<div class="viewcode-block" id="PermutationImportanceTest.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.PermutationImportanceTest.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Conduct permutation importance test and store drop features.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X_y</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">_check_binary</span><span class="p">(</span><span class="n">y</span><span class="p">)</span>

        <span class="n">process</span> <span class="o">=</span> <span class="n">make_pipeline</span><span class="p">(</span><span class="n">ImputeNaN</span><span class="p">(),</span> <span class="n">TargetMeanEncoding</span><span class="p">())</span>
        <span class="n">cv</span> <span class="o">=</span> <span class="n">StratifiedKFold</span><span class="p">(</span><span class="n">n_splits</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
        <span class="n">clf</span> <span class="o">=</span> <span class="n">RandomForestClassifier</span><span class="p">(</span><span class="n">n_estimators</span><span class="o">=</span><span class="mi">300</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span>

        <span class="n">Xt</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">fit_transform</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
        <span class="n">metrics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="n">feature_metrics_dic</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">feature_metrics_dic</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([])</span>

        <span class="k">for</span> <span class="n">train_idx</span><span class="p">,</span> <span class="n">valid_idx</span> <span class="ow">in</span> <span class="n">cv</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">Xt</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
            <span class="n">X_train</span><span class="p">,</span> <span class="n">X_valid</span><span class="p">,</span> <span class="n">y_train</span><span class="p">,</span> <span class="n">y_valid</span> <span class="o">=</span> \
                    <span class="n">Xt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">Xt</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">train_idx</span><span class="p">],</span> <span class="n">y</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="n">valid_idx</span><span class="p">]</span>
            
            <span class="n">clf</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X_train</span><span class="p">,</span> <span class="n">y_train</span><span class="p">)</span>
            <span class="n">y_pred</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
            <span class="n">metrics</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">metrics</span><span class="p">,</span> <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_pred</span><span class="p">))</span>
            
            <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">X_valid2</span> <span class="o">=</span> <span class="n">X_valid</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">X_shuffled</span> <span class="o">=</span> <span class="n">X_valid2</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">frac</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">random_state</span><span class="o">=</span><span class="mi">1234</span><span class="p">)</span>
                <span class="n">X_shuffled</span><span class="o">.</span><span class="n">index</span> <span class="o">=</span> <span class="n">X_valid2</span><span class="o">.</span><span class="n">index</span>
                <span class="n">X_valid2</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">X_shuffled</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="n">y_pred_shuffled</span> <span class="o">=</span> <span class="n">clf</span><span class="o">.</span><span class="n">predict_proba</span><span class="p">(</span><span class="n">X_valid2</span><span class="p">)[:,</span> <span class="mi">1</span><span class="p">]</span>
                <span class="n">feature_metrics_dic</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">feature_metrics_dic</span><span class="p">[</span><span class="n">feature</span><span class="p">],</span>
                                                        <span class="n">roc_auc_score</span><span class="p">(</span><span class="n">y_valid</span><span class="p">,</span> <span class="n">y_pred_shuffled</span><span class="p">))</span>

        <span class="n">base_metric</span> <span class="o">=</span> <span class="n">metrics</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">feature</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
            <span class="n">feature_metrics_dic</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span> <span class="o">=</span> <span class="n">base_metric</span> <span class="o">-</span> <span class="n">feature_metrics_dic</span><span class="p">[</span><span class="n">feature</span><span class="p">]</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">feature_metrics_dic</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">value</span> <span class="o">&lt;=</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="PermutationImportanceTest.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.PermutationImportanceTest.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by dropping columns specified in drop_columns</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">drop_columns</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">drop_columns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drop_columns_</span>

        <span class="k">if</span> <span class="n">drop_columns</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">X</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">drop_columns</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">Xt</span></div></div>


<div class="viewcode-block" id="UnionAppend"><a class="viewcode-back" href="../preprocessing.html#preprocessing.UnionAppend">[docs]</a><span class="k">class</span> <span class="nc">UnionAppend</span><span class="p">(</span><span class="n">BaseEstimator</span><span class="p">,</span> <span class="n">TransformerMixin</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Concatenates features extracted from original input data by AppendXXX\</span>
<span class="sd">    in the DataLiner package. Normally by applying AppendXXX in pipeline\</span>
<span class="sd">    input data will be treated in series and therefore appended feature\</span>
<span class="sd">    will be used in the next AppendXXX. By wrapping list of AppendXXX with\</span>
<span class="sd">    this class, append features will be processed in parallel and therefore\</span>
<span class="sd">    each AppendXXX class will only use the original input features.</span>

<span class="sd">    :param list append_list: List of AppendXXX in DataLiner package. \</span>
<span class="sd">    (default=None)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">append_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append_list</span> <span class="o">=</span> <span class="n">append_list</span>

<div class="viewcode-block" id="UnionAppend.fit"><a class="viewcode-back" href="../preprocessing.html#preprocessing.UnionAppend.fit">[docs]</a>    <span class="k">def</span> <span class="nf">fit</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Fit transformer by verifying AppendXXX specified.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :param pandas.Series y: Ignored. (default=None)</span>
<span class="sd">        :return: fitted object (self)</span>
<span class="sd">        :rtype: object</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">append_list_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_list</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_list_</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Please specify list of AppendXXX from DataLiner class.&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">trans</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_list_</span><span class="p">:</span>
            <span class="n">trans</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

        <span class="k">return</span> <span class="bp">self</span></div>

<div class="viewcode-block" id="UnionAppend.transform"><a class="viewcode-back" href="../preprocessing.html#preprocessing.UnionAppend.transform">[docs]</a>    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">X</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform X by transforming X in parallel and appending to original input data.</span>

<span class="sd">        :param pandas.DataFrame X: Input dataframe</span>
<span class="sd">        :return: Transformed input DataFrame</span>
<span class="sd">        :rtype: pandas.DataFrame</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">check_is_fitted</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="n">_check_X</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
        <span class="n">Xt</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="k">for</span> <span class="n">trans</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">append_list_</span><span class="p">:</span>
            <span class="n">X_ap</span> <span class="o">=</span> <span class="n">trans</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">X</span><span class="p">)</span>
            <span class="n">append_col</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">X_ap</span><span class="o">.</span><span class="n">columns</span><span class="p">,</span> <span class="n">X</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>
            <span class="n">Xt</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">Xt</span><span class="p">,</span> <span class="n">X_ap</span><span class="p">[</span><span class="n">append_col</span><span class="p">]],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">Xt</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2020, Author

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>